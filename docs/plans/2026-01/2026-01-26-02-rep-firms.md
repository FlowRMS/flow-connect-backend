# Rep Firms

- **Status**: ðŸŸ¦ Complete
- **Linear Task**: [FLO-1325](https://linear.app/flow-labs/issue/FLO-1325/flowpos-rep-firms)
- **Created**: 2026-01-26 21:18 -03
- **Approved**: 2026-01-27 09:16 -03
- **Finished**: 2026-01-27 13:55 -03
- **PR**: [#22](https://github.com/FlowRMS/flow-py-connect/pull/22)
- **Commit Prefix**: Rep Firms

---

## Table of Contents

- [Overview](#overview)
- [Design Decisions](#design-decisions)
- [Critical Files](#critical-files)
- [Phase 1: Geography Domain](#phase-1-geography-domain)
- [Phase 2: Connection Search - Rep Firms Parameter](#phase-2-connection-search---rep-firms-parameter)
- [Phase 3: Connection Territories](#phase-3-connection-territories)
- [Phase 4: Update Connection Territories Mutation](#phase-4-update-connection-territories-mutation)
- [Phase 5: Verification](#phase-5-verification)
- [Changes During Testing](#changes-during-testing)
- [Results](#results)

---

## Overview

Add support for Rep Firms in the connection search functionality. Key features:

1. **New `repFirms` parameter** in `connectionSearch` - When `true`, search for `rep_firm` organizations instead of `distributor` (only manufacturers can use this)
2. **New `subdivisions` field** in `OrganizationLiteResponse` - Populated with connection territories when `repFirms=true` and the organization has an accepted connection
3. **New Geography domain** - `Country` and `Subdivision` entities (per tenant, using ISO 3166-2)
4. **New mutation** to manage connection territories - Manufacturers assign territories to their rep firm connections

### Key Business Rule: Territories are Connection-Specific

Territories (subdivisions) are assigned per **Connection**, not per Rep Firm globally:

```
Manufacturer A â”€â”€connectionâ”€â”€> RepFirm B â”€â”€ [Territories: CA, NV]
Manufacturer C â”€â”€connectionâ”€â”€> RepFirm B â”€â”€ [Territories: TX, AZ]
```

The same Rep Firm can have different territory coverage for different Manufacturers.

---

## Design Decisions

### DD-1: Domain Name for Country/Subdivision Entities âœ“

**Decision**: `geography`

Explicit, professional, and extensible for future entities like cities, zip codes, etc.

### DD-2: Territories Relationship Architecture âœ“

**Decision**: Through Connection (Option A)

**Design**:
- **Join Table**: `connection_territories` with `connection_id` and `subdivision_id`
- **Scope**: Territories are tied to the Manufacturer â†” RepFirm connection
- **Behavior**: Same Rep Firm can have different territories per Manufacturer

**Join Table Schema**:

| | **connect_pos.connection_territories** | |
|-----|------|-------|
| **Column** | **Type** | **Constraints** |
| `id` | `UUID` | PK |
| `connection_id` | `UUID` | FK â†’ `connections`, NOT NULL |
| `subdivision_id` | `UUID` | FK â†’ `subdivisions`, NOT NULL |
| `created_at` | `DateTime` | NOT NULL |
| | **Indexes** | |
| | `ix_connection_territories_connection_id` | `connection_id` |
| | **Constraints** | |
| | `uq_connection_territory` | UNIQUE(`connection_id`, `subdivision_id`) |

### DD-3: Country and Subdivision Seed Data âœ“

**Decision**: Alembic migration

- **Country**: USA only (for now)
- **Subdivisions**: All 50 US states + DC (51 total) with name and ISO 3166-2 code
- Data seeded directly in the migration to ensure it's always present

### DD-4: Mutation Design âœ“

**Decision**: Connection-based mutation, manufacturer-only access

```graphql
updateConnectionTerritories(
  connectionId: ID!
  subdivisionIds: [ID!]!
): ConnectionResponse!
```

**Behavior**: Replace-all semantics (sets exactly the provided subdivisions)

**Access**: Only manufacturers can update territories for their connections

---

## Critical Files

| Type | File | Status |
|------|------|--------|
| Model | [`app/graphql/geography/models/geography.py`](../../app/graphql/geography/models/geography.py) | âœ… |
| Model | [`app/graphql/geography/models/connection_territory.py`](../../app/graphql/geography/models/connection_territory.py) | âœ… |
| Repository | [`app/graphql/geography/repositories/subdivision_repository.py`](../../app/graphql/geography/repositories/subdivision_repository.py) | âœ… |
| Repository | [`app/graphql/geography/repositories/connection_territory_repository.py`](../../app/graphql/geography/repositories/connection_territory_repository.py) | âœ… |
| Service | [`app/graphql/geography/services/connection_territory_service.py`](../../app/graphql/geography/services/connection_territory_service.py) | âœ… |
| Types | [`app/graphql/geography/strawberry/geography_types.py`](../../app/graphql/geography/strawberry/geography_types.py) | âœ… |
| Migration | [`alembic/versions/20260127_create_geography_tables.py`](../../alembic/versions/20260127_create_geography_tables.py) | âœ… |
| Mutation | [`app/graphql/geography/mutations/connection_territory_mutations.py`](../../app/graphql/geography/mutations/connection_territory_mutations.py) | âœ… |
| Modified | [`app/graphql/organizations/queries/connection_queries.py`](../../app/graphql/organizations/queries/connection_queries.py) | âœ… |
| Modified | [`app/graphql/organizations/services/organization_search_service.py`](../../app/graphql/organizations/services/organization_search_service.py) | âœ… |
| Modified | [`app/graphql/organizations/strawberry/organization_types.py`](../../app/graphql/organizations/strawberry/organization_types.py) | âœ… |
| Test | [`tests/graphql/geography/`](../../tests/graphql/geography/) | âœ… |

---

## Phase 1: Geography Domain

_Create the new geography domain with Country and Subdivision entities._

### 1.1 RED: Write failing tests for Country and Subdivision models âœ…

_Skipped per TDD standards - database models are validated by type checking and integration._

### 1.2 GREEN: Create Country and Subdivision models âœ…

**File**: [`app/graphql/geography/models/geography.py`](../../app/graphql/geography/models/geography.py)

**Country Model Schema**:

| | **connect_geography.countries** | |
|-----|------|-------|
| **Column** | **Type** | **Constraints** |
| `id` | `UUID` | PK |
| `name` | `String(100)` | NOT NULL, UNIQUE |
| `code` | `String(3)` | NOT NULL, UNIQUE (ISO 3166-1 alpha-3) |
| `created_at` | `DateTime` | NOT NULL |

**Subdivision Model Schema**:

| | **connect_geography.subdivisions** | |
|-----|------|-------|
| **Column** | **Type** | **Constraints** |
| `id` | `UUID` | PK |
| `country_id` | `UUID` | FK â†’ `countries`, NOT NULL |
| `name` | `String(100)` | NOT NULL |
| `iso_code` | `String(10)` | NOT NULL, UNIQUE (ISO 3166-2, e.g., `US-CA`) |
| `created_at` | `DateTime` | NOT NULL |
| | **Indexes** | |
| | `ix_subdivisions_country_id` | `country_id` |

### 1.3 GREEN: Create migration with seed data âœ…

**File**: [`alembic/versions/20260127_create_geography_tables.py`](../../alembic/versions/20260127_create_geography_tables.py)

- Creates `connect_geography` schema
- Creates `countries` and `subdivisions` tables
- Seeds USA country and all 50 US states + DC (with ISO 3166-2 codes)

### 1.4 REFACTOR: Create repository and types âœ…

**Files**:
- [`app/graphql/geography/repositories/subdivision_repository.py`](../../app/graphql/geography/repositories/subdivision_repository.py)
- [`app/graphql/geography/strawberry/geography_types.py`](../../app/graphql/geography/strawberry/geography_types.py)

---

## Phase 2: Connection Search - Rep Firms Parameter

_Add the `repFirms` parameter to the connectionSearch query._

### 2.1 RED: Write failing tests for repFirms parameter âœ…

**File**: [`tests/graphql/organizations/test_organization_search_service.py`](../../tests/graphql/organizations/test_organization_search_service.py)

- `test_rep_firms_true_searches_for_rep_firm_orgs`
- `test_rep_firms_false_searches_for_distributor_orgs`
- `test_rep_firms_raises_error_for_non_manufacturer`

### 2.2 GREEN: Implement repFirms parameter âœ…

**Files**:
- [`app/graphql/organizations/queries/connection_queries.py`](../../app/graphql/organizations/queries/connection_queries.py)
- [`app/graphql/organizations/services/organization_search_service.py`](../../app/graphql/organizations/services/organization_search_service.py)

### 2.3 GREEN: Add subdivisions field to OrganizationLiteResponse âœ…

**File**: [`app/graphql/organizations/strawberry/organization_types.py`](../../app/graphql/organizations/strawberry/organization_types.py)

- Added `subdivisions: list[SubdivisionResponse]` field (defaults to empty list)
- Updated `from_orm_model()` to accept optional `subdivisions` parameter

### 2.4 REFACTOR: Update schema and finalize âœ…

**File**: [`schema.graphql`](../../schema.graphql)

- `connectionSearch` now has `repFirms: Boolean! = false` parameter
- `OrganizationLiteResponse` now has `subdivisions: [SubdivisionResponse!]!` field

---

## Phase 3: Connection Territories

_Create the connection territories model and infrastructure._

### 3.1 RED: Write failing tests for ConnectionTerritory model âœ…

_Skipped per TDD standards - database models are validated by type checking and integration._

### 3.2 GREEN: Create ConnectionTerritory model âœ…

**Files**:
- [`app/graphql/geography/models/connection_territory.py`](../../app/graphql/geography/models/connection_territory.py)
- [`alembic/versions/20260127_create_connection_territories.py`](../../alembic/versions/20260127_create_connection_territories.py)

### 3.3 GREEN: Create repository âœ…

**File**: [`app/graphql/geography/repositories/connection_territory_repository.py`](../../app/graphql/geography/repositories/connection_territory_repository.py)

- `get_by_connection_id(connection_id)` â†’ list of territories
- `get_subdivisions_by_connection_id(connection_id)` â†’ list of subdivisions
- `set_territories(connection_id, subdivision_ids)` â†’ replace all territories

### 3.4 REFACTOR: Add to DI container âœ…

**File**: [`app/graphql/di/repository_providers.py`](../../app/graphql/di/repository_providers.py)

- Added `app.graphql.geography` to auto-discovery modules

---

## Phase 4: Update Connection Territories Mutation

_Create the mutation to manage connection territories._

### 4.1 RED: Write failing tests for mutation âœ…

**File**: [`tests/graphql/geography/test_connection_territory_service.py`](../../tests/graphql/geography/test_connection_territory_service.py)

- `test_update_territories_replaces_correctly`
- `test_update_territories_raises_for_non_manufacturer`
- `test_update_territories_raises_for_nonexistent_connection`
- `test_update_territories_raises_for_invalid_subdivision_ids`
- `test_update_territories_raises_for_unauthorized_connection`

### 4.2 GREEN: Create service âœ…

**File**: [`app/graphql/geography/services/connection_territory_service.py`](../../app/graphql/geography/services/connection_territory_service.py)

### 4.3 GREEN: Create mutation resolver âœ…

**File**: [`app/graphql/geography/mutations/connection_territory_mutations.py`](../../app/graphql/geography/mutations/connection_territory_mutations.py)

### 4.4 REFACTOR: Error handling and schema update âœ…

**Files**:
- [`app/graphql/schemas/schema.py`](../../app/graphql/schemas/schema.py) - Added ConnectionTerritoryMutations
- [`app/graphql/di/service_providers.py`](../../app/graphql/di/service_providers.py) - Added geography module
- [`app/graphql/connections/repositories/connection_repository.py`](../../app/graphql/connections/repositories/connection_repository.py) - Added `get_by_id` method
- [`schema.graphql`](../../schema.graphql) - New mutation `updateConnectionTerritories`

---

## Phase 5: Verification

_Run all tests and verify functionality._

### 5.1 Run test suite âœ…

- `task all` passes âœ…
- 233 tests pass, no regressions âœ…
- Type checking: 0 errors âœ…
- Linting: 0 errors âœ…

### 5.2 Manual verification âœ…

**Schema introspection verified:**
- `connectionSearch` has `repFirms` parameter âœ…
- `updateConnectionTerritories` mutation exists âœ…
- `OrganizationLiteResponse.subdivisions` field exists âœ…
- `SubdivisionResponse` type: `id`, `name`, `isoCode`, `countryId` âœ…
- `UpdateConnectionTerritoriesResponse` type: `connectionId`, `subdivisions` âœ…

_Note: Business logic testing blocked by missing user data in database (environment issue, not code issue)._

---

## Changes During Testing

_Issues discovered and fixed during testing/review. Prefixes: BF = bugfix, CH = behavior change._

### CH-1: Populate subdivisions for connected rep firms in search results âœ…

**Problem**: Original design (DD-5) returned empty subdivisions in `connectionSearch` results, deferring to connection detail views. User requested subdivisions be populated directly in search results for connected rep firms.

**Files**:
- [`app/graphql/organizations/repositories/organization_search_repository.py`](../../app/graphql/organizations/repositories/organization_search_repository.py) - Added `connection_id` to search results
- [`app/graphql/organizations/services/organization_search_result.py`](../../app/graphql/organizations/services/organization_search_result.py) - Added `connection_id` and `subdivisions` fields
- [`app/graphql/organizations/services/organization_search_service.py`](../../app/graphql/organizations/services/organization_search_service.py) - Fetch subdivisions for connected orgs when `rep_firms=True`
- [`app/graphql/organizations/queries/connection_queries.py`](../../app/graphql/organizations/queries/connection_queries.py) - Pass subdivisions to response
- [`tests/graphql/organizations/test_organization_search_service.py`](../../tests/graphql/organizations/test_organization_search_service.py) - Updated test fixtures

**Change**: When `repFirms=true` and the organization has `ConnectionStatus.ACCEPTED`, the `subdivisions` field is now populated with the connection's assigned territories.

---

## Results

| Metric | Value |
|--------|-------|
| Duration | ~4.5 hours |
| Phases | 5 |
| Files Modified | 31 |
| Tests Added | 8 |
